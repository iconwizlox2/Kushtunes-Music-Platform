"use strict";(()=>{var e={};e.id=1567,e.ids=[1567],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},15104:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>h,originalPathname:()=>g,requestAsyncStorage:()=>m,routeModule:()=>c,serverHooks:()=>p,staticGenerationAsyncStorage:()=>d,staticGenerationBailout:()=>f});var r={};a.r(r),a.d(r,{GET:()=>GET});var s=a(10884),n=a(16132),o=a(95798),l=a(53524),u=a(8192);function calculateTotalStreams(e){return e.reduce((e,t)=>e+t.streams,0)}function calculateTotalRevenue(e){return e.reduce((e,t)=>e+t.revenue,0)}function getTopCountries(e,t=10){let a=new Map;return e.forEach(e=>{let t=a.get(e.country)||{streams:0,revenue:0};a.set(e.country,{streams:t.streams+e.streams,revenue:t.revenue+e.revenue})}),Array.from(a.entries()).map(([e,t])=>({country:e,...t})).sort((e,t)=>t.streams-e.streams).slice(0,t)}function getTopPlatforms(e,t=10){let a=new Map;return e.forEach(e=>{let t=a.get(e.platform)||{streams:0,revenue:0};a.set(e.platform,{streams:t.streams+e.streams,revenue:t.revenue+e.revenue})}),Array.from(a.entries()).map(([e,t])=>({platform:e,...t})).sort((e,t)=>t.streams-e.streams).slice(0,t)}function calculateMonthlyGrowth(e){let t=new Map;return e.forEach(e=>{let a=e.date.toISOString().substring(0,7),r=t.get(a)||{streams:0,revenue:0};t.set(a,{streams:r.streams+e.streams,revenue:r.revenue+e.revenue})}),Array.from(t.entries()).map(([e,t])=>({month:e,...t})).sort((e,t)=>e.month.localeCompare(t.month))}function calculateGrowthPercentage(e,t){return 0===t?e>0?100:0:Math.round((e-t)/t*100)}function formatNumber(e){return new Intl.NumberFormat("en-US").format(e)}function generateAnalyticsSummary(e,t,a){let r=calculateTotalStreams(e),s=calculateTotalRevenue(e),n=a.length,o=t.length,l=getTopCountries(e,10),u=getTopPlatforms(e,10),i=calculateMonthlyGrowth(e);return{totalStreams:r,totalRevenue:s,totalTracks:n,totalReleases:o,topCountries:l,topPlatforms:u,monthlyGrowth:i}}function calculateTrackAnalytics(e,t,a){let r=t.filter(t=>t.trackId===e),s=calculateTotalStreams(r),n=calculateTotalRevenue(r),o=getTopCountries(r,5),l=getTopPlatforms(r,5),u=new Map;r.forEach(e=>{let t=e.date.toISOString().split("T")[0];u.set(t,(u.get(t)||0)+e.streams)});let i=Array.from(u.entries()).map(([e,t])=>({date:e,streams:t})).sort((e,t)=>e.date.localeCompare(t.date));return{trackId:e,trackTitle:a,totalStreams:s,totalRevenue:n,topCountries:o,topPlatforms:l,dailyStreams:i}}function calculateReleaseAnalytics(e,t,a){let r=t.filter(t=>t.releaseId===e),s=calculateTotalStreams(r),n=calculateTotalRevenue(r),o=a.tracks.map(e=>calculateTrackAnalytics(e.id,r,e.title));return{releaseId:e,releaseTitle:a.metadata.title,totalStreams:s,totalRevenue:n,trackCount:a.tracks.length,tracks:o,releaseDate:new Date(a.metadata.releaseDate),distributionDate:a.distributionDate?new Date(a.distributionDate):void 0}}function generatePerformanceInsights(e){let t=[];if(e.monthlyGrowth.length>=2){let a=e.monthlyGrowth[e.monthlyGrowth.length-1],r=e.monthlyGrowth[e.monthlyGrowth.length-2],s=calculateGrowthPercentage(a.streams,r.streams),n=calculateGrowthPercentage(a.revenue,r.revenue);s>0&&t.push(`Streams increased by ${s}% this month`),n>0&&t.push(`Revenue increased by ${n}% this month`)}if(e.topCountries.length>0){let a=e.topCountries[0];t.push(`${a.country} is your top market with ${formatNumber(a.streams)} streams`)}if(e.topPlatforms.length>0){let a=e.topPlatforms[0];t.push(`${a.platform} generates the most streams with ${formatNumber(a.streams)}`)}return t}function getTimeBasedAnalytics(e,t){let a=new Map;return e.forEach(e=>{let r;switch(t){case"daily":default:r=e.date.toISOString().split("T")[0];break;case"weekly":let s=new Date(e.date);s.setDate(s.getDate()-s.getDay()),r=s.toISOString().split("T")[0];break;case"monthly":r=e.date.toISOString().substring(0,7)}let n=a.get(r)||{streams:0,revenue:0};a.set(r,{streams:n.streams+e.streams,revenue:n.revenue+e.revenue})}),Array.from(a.entries()).map(([e,t])=>({period:e,...t})).sort((e,t)=>e.period.localeCompare(t.period))}let i=new l.PrismaClient;async function GET(e){try{let t=e.headers.get("authorization"),a=(0,u.oA)(t);if(!a)return o.Z.json({success:!1,message:"Authentication required"},{status:401});let r=(0,u.WX)(a);if(!r)return o.Z.json({success:!1,message:"Invalid authentication token"},{status:401});let{searchParams:s}=new URL(e.url),n=s.get("releaseId"),l=s.get("trackId"),c=s.get("period")||"monthly",m=s.get("startDate"),d=s.get("endDate"),p={};m&&(p.gte=new Date(m)),d&&(p.lte=new Date(d));let h=await i.release.findMany({where:{primaryArtistId:r.id},include:{tracks:!0}});h.map(e=>e.id);let f=h.flatMap(e=>e.tracks.map(e=>e.id));if(n){let e=h.find(e=>e.id===n);if(!e)return o.Z.json({success:!1,message:"Release not found"},{status:404});let t=generateMockStreamData(n,f,p),a=calculateReleaseAnalytics(n,t,e);return o.Z.json({success:!0,data:{release:{id:e.id,title:e.title,releaseDate:e.releaseDate,status:e.status},analytics:{...a,insights:generatePerformanceInsights({totalStreams:a.totalStreams,totalRevenue:a.totalRevenue,totalTracks:a.trackCount,totalReleases:1,topCountries:a.tracks.reduce((e,t)=>[...e,...t.topCountries||[]],[]),topPlatforms:a.tracks.reduce((e,t)=>[...e,...t.topPlatforms||[]],[]),monthlyGrowth:[]})}}})}if(l){let e=h.flatMap(e=>e.tracks).find(e=>e.id===l);if(!e)return o.Z.json({success:!1,message:"Track not found"},{status:404});let t=generateMockStreamData(n,[l],p),a=calculateTrackAnalytics(l,t,e.title);return o.Z.json({success:!0,data:{track:{id:e.id,title:e.title,releaseId:e.releaseId},analytics:a}})}let g=generateMockStreamData(null,f,p),y=generateAnalyticsSummary(g,h,h.flatMap(e=>e.tracks)),w=generatePerformanceInsights(y),v=getTimeBasedAnalytics(g,c);return o.Z.json({success:!0,data:{summary:{...y,insights:w,timeBasedAnalytics:v},releases:h.map(e=>({id:e.id,title:e.title,status:e.status,trackCount:e.tracks.length,releaseDate:e.releaseDate}))}})}catch(e){return console.error("Analytics error:",e),o.Z.json({success:!1,message:"Failed to fetch analytics"},{status:500})}}function generateMockStreamData(e,t,a){let r=["spotify","apple-music","youtube-music","amazon-music","deezer"],s=["US","GB","CA","AU","DE","FR","IT","ES","NL","SE"],n=[],o=a.gte||new Date(Date.now()-7776e6),l=a.lte||new Date;return t.forEach(t=>{if(!e||t.startsWith(e))for(let a=new Date(o);a<=l;a.setDate(a.getDate()+1))r.forEach(r=>{s.forEach(s=>{let o=Math.floor(1e3*Math.random())+100,l=o*(.01*Math.random()+.003);n.push({id:`${t}_${r}_${s}_${a.toISOString().split("T")[0]}`,releaseId:e||t.split("_")[0],trackId:t,platform:r,country:s,date:new Date(a),streams:o,revenue:Math.round(100*l)/100,currency:"USD"})})})}),n}let c=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/analytics/route",pathname:"/api/analytics",filename:"route",bundlePath:"app/api/analytics/route"},resolvedPagePath:"/Users/wizloxssd/Downloads/kushtunes-starter/app/api/analytics/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:d,serverHooks:p,headerHooks:h,staticGenerationBailout:f}=c,g="/api/analytics/route"}};var t=require("../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[4736,8592],()=>__webpack_exec__(15104));module.exports=a})();