"use strict";(()=>{var e={};e.id=3700,e.ids=[3700],e.modules={97352:e=>{e.exports=require("@prisma/client/runtime/library.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},57147:e=>{e.exports=require("fs")},71017:e=>{e.exports=require("path")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},17483:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>y,originalPathname:()=>h,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>E,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>f});var r={};a.r(r),a.d(r,{GET:()=>GET,POST:()=>POST});var n=a(10884),s=a(16132),u=a(95798),o=a(96810),i=a(8192);let c={spotify:.0033,"apple-music":.0078,"youtube-music":69e-5,"amazon-music":.004,deezer:.0019,tidal:.0125,pandora:.0013,soundcloud:.0025,youtube:69e-5,facebook:69e-5,instagram:69e-5,tiktok:69e-5,snapchat:69e-5,twitch:69e-5,other:.002},l={US:1,GB:.85,CA:.8,AU:.75,DE:.7,FR:.65,IT:.6,ES:.55,NL:.7,SE:.75,NO:.8,DK:.75,FI:.7,CH:.8,AT:.7,BE:.65,IE:.75,NZ:.7,JP:.6,KR:.55,SG:.65,HK:.6,TW:.55,MX:.4,BR:.35,AR:.3,CL:.3,CO:.25,PE:.25,IN:.2,CN:.15,RU:.25,TR:.3,ZA:.25,NG:.15,EG:.2,KE:.15,GH:.15,MA:.2,TN:.2,DZ:.2,LY:.2,SD:.15,ET:.15,UG:.15,TZ:.15,ZM:.15,ZW:.15,BW:.2,NA:.2,SZ:.2,LS:.2,MW:.15,MZ:.15,MG:.15,MU:.2,SC:.2,KM:.15,DJ:.15,SO:.15,ER:.15,SS:.15,CF:.15,TD:.15,NE:.15,ML:.15,BF:.15,CI:.15,LR:.15,SL:.15,GN:.15,GW:.15,GM:.15,SN:.15,MR:.15,CV:.2,ST:.15,GQ:.15,GA:.15,CG:.15,CD:.15,AO:.15,BI:.15,RW:.15,other:.3};function calculateStreamEarnings(e,t,a=1){let r=c[e]||c.other,n=l[t]||l.other,s=r*n;return{revenue:Math.round(100*(s*a))/100,rate:s}}function calculateTotalEarnings(e){return e.reduce((e,t)=>e+t.netEarnings,0)}function calculateMonthlyEarnings(e){let t=new Map;return e.forEach(e=>{let a=e.date.toISOString().substring(0,7),r=t.get(a)||{earnings:0,streams:0};t.set(a,{earnings:r.earnings+e.netEarnings,streams:r.streams+e.streams})}),Array.from(t.entries()).map(([e,t])=>({month:e,...t})).sort((e,t)=>e.month.localeCompare(t.month))}function calculatePlatformBreakdown(e){let t=new Map;return e.forEach(e=>{let a=t.get(e.platform)||{earnings:0,streams:0,totalRate:0,count:0};t.set(e.platform,{earnings:a.earnings+e.netEarnings,streams:a.streams+e.streams,totalRate:a.totalRate+e.payoutRate,count:a.count+1})}),Array.from(t.entries()).map(([e,t])=>({platform:e,earnings:t.earnings,streams:t.streams,rate:t.count>0?t.totalRate/t.count:0})).sort((e,t)=>t.earnings-e.earnings)}function calculateCountryBreakdown(e){let t=new Map;return e.forEach(e=>{let a=t.get(e.country)||{earnings:0,streams:0,totalRate:0,count:0};t.set(e.country,{earnings:a.earnings+e.netEarnings,streams:a.streams+e.streams,totalRate:a.totalRate+e.payoutRate,count:a.count+1})}),Array.from(t.entries()).map(([e,t])=>({country:e,earnings:t.earnings,streams:t.streams,rate:t.count>0?t.totalRate/t.count:0})).sort((e,t)=>t.earnings-e.earnings)}function calculateAverageRatePerStream(e){if(0===e.length)return 0;let t=calculateTotalEarnings(e),a=e.reduce((e,t)=>e+t.streams,0);return a>0?Math.round(t/a*1e4)/1e4:0}function calculateAvailableBalance(e,t){let a=calculateTotalEarnings(e),r=t.filter(e=>"COMPLETED"===e.status).reduce((e,t)=>e+t.amount,0);return Math.max(0,a-r)}function calculatePendingPayouts(e){return e.filter(e=>"PENDING"===e.status||"PROCESSING"===e.status).reduce((e,t)=>e+t.amount,0)}function generateEarningsSummary(e,t){let a=calculateTotalEarnings(e),r=e.reduce((e,t)=>e+t.streams,0),n=calculateAverageRatePerStream(e),s=calculateMonthlyEarnings(e),u=calculatePlatformBreakdown(e),o=calculateCountryBreakdown(e),i=calculatePendingPayouts(t),c=calculateAvailableBalance(e,t);return{totalEarnings:a,totalStreams:r,averageRatePerStream:n,currency:"USD",monthlyEarnings:s,platformBreakdown:u,countryBreakdown:o,pendingPayouts:i,availableBalance:c}}function validatePayoutRequest(e,t,a=10){return e<a?{valid:!1,error:`Minimum payout amount is $${a}`}:e>t?{valid:!1,error:"Insufficient balance for payout"}:e<=0?{valid:!1,error:"Payout amount must be greater than 0"}:{valid:!0}}function calculatePayoutFees(e,t){let a=Math.round(e*(({paypal:.029,stripe:.029,"bank-transfer":.01,crypto:.005,check:.02})[t]||.029)*100)/100;return{fee:a,netAmount:Math.round((e-a)*100)/100}}function formatCurrency(e,t="USD"){return new Intl.NumberFormat("en-US",{style:"currency",currency:t,minimumFractionDigits:2}).format(e)}function getPayoutStatusColor(e){switch(e){case"PENDING":return"yellow";case"PROCESSING":return"blue";case"COMPLETED":return"green";case"FAILED":return"red";default:return"gray"}}function getPayoutStatusText(e){switch(e){case"PENDING":return"Pending";case"PROCESSING":return"Processing";case"COMPLETED":return"Completed";case"FAILED":return"Failed";default:return"Unknown"}}function calculateEarningsGrowth(e,t){return 0===t?e>0?100:0:Math.round((e-t)/t*100)}function generateEarningsInsights(e){let t=[];if(e.platformBreakdown.length>0){let a=e.platformBreakdown[0];t.push(`${a.platform} generates ${formatCurrency(a.earnings)} (${Math.round(a.earnings/e.totalEarnings*100)}% of total earnings)`)}if(e.countryBreakdown.length>0){let a=e.countryBreakdown[0];t.push(`${a.country} is your top earning market with ${formatCurrency(a.earnings)}`)}if(e.monthlyEarnings.length>=2){let a=e.monthlyEarnings[e.monthlyEarnings.length-1],r=e.monthlyEarnings[e.monthlyEarnings.length-2],n=calculateEarningsGrowth(a.earnings,r.earnings);n>0&&t.push(`Earnings increased by ${n}% this month`)}return t}let d=new o.PrismaClient;async function GET(e){try{let t=e.headers.get("authorization"),a=(0,i.oA)(t);if(!a)return u.Z.json({success:!1,message:"Authentication required"},{status:401});let r=(0,i.WX)(a);if(!r)return u.Z.json({success:!1,message:"Invalid authentication token"},{status:401});let{searchParams:n}=new URL(e.url);n.get("period");let s=n.get("startDate"),o=n.get("endDate"),c={};s&&(c.gte=new Date(s)),o&&(c.lte=new Date(o));let l=await d.release.findMany({where:{primaryArtistId:r.id},include:{tracks:!0}}),m=l.flatMap(e=>e.tracks.map(e=>e.id)),g=generateMockEarningsData(r.id,m,c),p=await d.payout.findMany({where:{artistId:r.id},orderBy:{createdAt:"desc"}}),E=p.map(e=>({id:e.id,userId:e.artistId,amount:e.amount,currency:"USD",requestedAt:e.createdAt,paymentMethod:e.method,status:"APPROVED"===e.status?"PROCESSING":"PROCESSED"===e.status?"COMPLETED":e.status,processedAt:e.processedAt||void 0,reference:e.reference})),y=generateEarningsSummary(g,E),f=generateEarningsInsights(y);return u.Z.json({success:!0,data:{summary:{...y,insights:f},payoutHistory:p.map(e=>{let t="APPROVED"===e.status?"PROCESSING":"PROCESSED"===e.status?"COMPLETED":e.status;return{...e,status:t,statusColor:getPayoutStatusColor(t),statusText:getPayoutStatusText(t)}}),releases:l.map(e=>({id:e.id,title:e.title,trackCount:e.tracks.length,releaseDate:e.releaseDate}))}})}catch(e){return console.error("Earnings error:",e),u.Z.json({success:!1,message:"Failed to fetch earnings data"},{status:500})}}async function POST(e){try{let t=e.headers.get("authorization"),a=(0,i.oA)(t);if(!a)return u.Z.json({success:!1,message:"Authentication required"},{status:401});let r=(0,i.WX)(a);if(!r)return u.Z.json({success:!1,message:"Invalid authentication token"},{status:401});let n=await e.json(),{amount:s,paymentMethod:o,currency:c="USD"}=n;if(!s||!o)return u.Z.json({success:!1,message:"Amount and payment method are required"},{status:400});let l=await d.release.findMany({where:{primaryArtistId:r.id},include:{tracks:!0}}),m=l.flatMap(e=>e.tracks.map(e=>e.id)),g=generateMockEarningsData(r.id,m),p=await d.payout.findMany({where:{artistId:r.id}}),E=p.map(e=>({id:e.id,userId:e.artistId,amount:e.amount,currency:"USD",requestedAt:e.createdAt,paymentMethod:e.method,status:"APPROVED"===e.status?"PROCESSING":"PROCESSED"===e.status?"COMPLETED":e.status,processedAt:e.processedAt||void 0,reference:e.reference})),y=generateEarningsSummary(g,E),f=y.availableBalance,h=validatePayoutRequest(s,f);if(!h.valid)return u.Z.json({success:!1,message:h.error},{status:400});let{fee:S,netAmount:P}=calculatePayoutFees(s,o),D=await d.payout.create({data:{artistId:r.id,amount:parseFloat(s),method:o,status:"PENDING",reference:`PAYOUT_${Date.now()}`}});return u.Z.json({success:!0,message:"Payout request submitted successfully",data:{payoutId:D.id,amount:formatCurrency(D.amount,"USD"),fee:formatCurrency(S,"USD"),netAmount:formatCurrency(P,"USD"),status:getPayoutStatusText("APPROVED"===D.status?"PROCESSING":"PROCESSED"===D.status?"COMPLETED":D.status),requestedAt:D.createdAt,estimatedProcessingTime:"3-5 business days"}})}catch(e){return console.error("Payout request error:",e),u.Z.json({success:!1,message:"Failed to process payout request"},{status:500})}}function generateMockEarningsData(e,t,a={}){let r=["spotify","apple-music","youtube-music","amazon-music","deezer"],n=["US","GB","CA","AU","DE","FR","IT","ES","NL","SE"],s=[],u=a.gte||new Date(Date.now()-7776e6),o=a.lte||new Date;return t.forEach(t=>{for(let a=new Date(u);a<=o;a.setDate(a.getDate()+1))r.forEach(r=>{n.forEach(n=>{let u=Math.floor(1e3*Math.random())+100,o=calculateStreamEarnings(r,n,u);s.push({id:`${t}_${r}_${n}_${a.toISOString().split("T")[0]}`,userId:e,releaseId:t.split("_")[0],trackId:t,platform:r,country:n,date:new Date(a),streams:u,revenue:o.revenue,currency:"USD",payoutRate:o.rate,netEarnings:o.revenue})})})}),s}let m=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/earnings/route",pathname:"/api/earnings",filename:"route",bundlePath:"app/api/earnings/route"},resolvedPagePath:"/Users/wizloxssd/Downloads/kushtunes-starter/app/api/earnings/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:p,serverHooks:E,headerHooks:y,staticGenerationBailout:f}=m,h="/api/earnings/route"}};var t=require("../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[729,6449,5798,6810,8752,8192],()=>__webpack_exec__(17483));module.exports=a})();