"use strict";(()=>{var e={};e.id=5998,e.ids=[5998],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},57441:e=>{e.exports=require("sharp")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},73292:e=>{e.exports=require("fs/promises")},71017:e=>{e.exports=require("path")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},1333:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>v,originalPathname:()=>w,requestAsyncStorage:()=>f,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>k});var r={};a.r(r),a.d(r,{GET:()=>GET,POST:()=>POST});var i=a(10884),s=a(16132),n=a(95798),o=a(53524),u=a(57441),l=a.n(u),d=a(6113);a(73292),a(71017),require("fs");let c={AUDIO:{MAX_SIZE:52428800,ALLOWED_TYPES:["audio/mpeg","audio/wav","audio/flac","audio/mp3"],ALLOWED_EXTENSIONS:[".mp3",".wav",".flac"]},IMAGE:{MAX_SIZE:2097152,ALLOWED_TYPES:["image/jpeg","image/jpg","image/png","image/webp"],ALLOWED_EXTENSIONS:[".jpg",".jpeg",".png",".webp"]}};function validateAudioFile(e){let{MAX_SIZE:t,ALLOWED_TYPES:a,ALLOWED_EXTENSIONS:r}=c.AUDIO;if(!a.includes(e.type))return{valid:!1,error:"Please upload MP3, WAV, or FLAC files only"};if(e.size>t)return{valid:!1,error:`File size must be less than ${Math.round(t/1048576)}MB`};let i="."+e.name.split(".").pop()?.toLowerCase();return r.includes(i)?{valid:!0,fileInfo:{name:e.name,size:e.size,type:e.type,extension:i}}:{valid:!1,error:"Invalid file extension"}}function validateImageFile(e){let{MAX_SIZE:t,ALLOWED_TYPES:a,ALLOWED_EXTENSIONS:r}=c.IMAGE;if(!a.includes(e.type))return{valid:!1,error:"Please upload JPG, PNG, or WebP files only"};if(e.size>t)return{valid:!1,error:`File size must be less than ${Math.round(t/1048576)}MB`};let i="."+e.name.split(".").pop()?.toLowerCase();return r.includes(i)?{valid:!0,fileInfo:{name:e.name,size:e.size,type:e.type,extension:i}}:{valid:!1,error:"Invalid file extension"}}function generateFileId(){return(0,d.randomBytes)(16).toString("hex")}function generateSafeFilename(e,t){e.split(".").pop()?.toLowerCase();let a=e.replace(/[^a-zA-Z0-9.-]/g,"_").replace(/_{2,}/g,"_").toLowerCase();return`${t}_${a}`}async function processAudioMetadata(e){return{duration:180,bitrate:320,sampleRate:44100,channels:2,format:"mp3"}}async function processImageMetadata(e){return{width:3e3,height:3e3,format:"jpeg",colorSpace:"sRGB"}}async function cleanupTempFiles(e){let{unlink:t}=await Promise.resolve().then(a.t.bind(a,73292,23));for(let a of e)try{await t(a)}catch(e){console.error(`Failed to delete temp file ${a}:`,e)}}function generateReleaseId(){return"REL_"+(0,d.randomBytes)(8).toString("hex").toUpperCase()}function generateUPC(){let e=Math.floor(1e12*Math.random()).toString().padStart(12,"0");return e}function generateISRC(e="US"){let t=new Date().getFullYear().toString().slice(-2),a=(0,d.randomBytes)(3).toString("hex").toUpperCase(),r=(0,d.randomBytes)(3).toString("hex").toUpperCase();return`${e}${t}${a}${r}`}function validateReleaseMetadata(e){let t=[];if((!e.title||e.title.trim().length<1)&&t.push("Release title is required"),(!e.artist||e.artist.trim().length<1)&&t.push("Artist name is required"),e.releaseDate){let a=new Date(e.releaseDate),r=new Date;r.setHours(0,0,0,0),a<r&&t.push("Release date cannot be in the past")}else t.push("Release date is required");return e.genre||t.push("Genre is required"),e.language||t.push("Language is required"),["SINGLE","EP","ALBUM"].includes(e.type)||t.push("Invalid release type"),{valid:0===t.length,errors:t}}function calculateReleaseDuration(e){return e.reduce((e,t)=>e+t.duration,0)}function formatDuration(e){return`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`}var p=a(8192);let m=new o.PrismaClient;async function optimizeImage(e){return await l()(e).resize(3e3,3e3,{fit:"cover",withoutEnlargement:!0}).jpeg({quality:85,progressive:!0,mozjpeg:!0}).toBuffer()}async function POST(e){try{let t=e.headers.get("authorization"),a=(0,p.oA)(t);if(!a)return n.Z.json({success:!1,message:"Authentication required"},{status:401});let r=(0,p.WX)(a);if(!r)return n.Z.json({success:!1,message:"Invalid authentication token"},{status:401});let i=await e.formData(),s=[],o=0;for(;i.has(`track_${o}`);){let e=i.get(`track_${o}`),t=i.get(`track_${o}_title`);e&&t&&s.push({title:t,audioFile:e}),o++}let u={title:i.get("title"),artist:i.get("artist"),releaseDate:i.get("releaseDate"),genre:i.get("genre"),language:i.get("language"),type:i.get("type")||"SINGLE"},l=i.get("artwork");if(!s.length||!u.title||!u.artist||!l)return n.Z.json({success:!1,message:"Missing required fields"},{status:400});let d=validateReleaseMetadata(u);if(!d.valid)return n.Z.json({success:!1,message:d.errors.join(", ")},{status:400});let c=s.map(e=>validateAudioFile(e.audioFile)),g=c.find(e=>!e.valid);if(g)return n.Z.json({success:!1,message:g.error},{status:400});let f=validateImageFile(l);if(!f.valid)return n.Z.json({success:!1,message:f.error},{status:400});let h=generateReleaseId(),y=generateUPC(),v=[];try{let e=Buffer.from(await l.arrayBuffer()),t=await optimizeImage(e),a=generateFileId(),i=generateSafeFilename(l.name,a),o=`/uploads/${r.id}/images/${i}`;v.push(o);let d=await processImageMetadata(o),c=await m.release.create({data:{id:h,primaryArtistId:r.id,title:u.title,releaseDate:new Date(u.releaseDate),status:"DRAFT",coverUrl:`https://kushtunes-storage.com/artwork/${a}.jpg`,genre:u.genre,territories:JSON.stringify(["US"]),upc:y}}),p=[];for(let e=0;e<s.length;e++){let t=s[e],a=generateFileId(),i=generateISRC(),n=`/uploads/${r.id}/audio/${generateSafeFilename(t.audioFile.name,a)}`;v.push(n);let o=await processAudioMetadata(n),l=await m.track.create({data:{id:a,releaseId:h,title:t.title,trackNumber:e+1,isrc:i,audioUrl:`https://kushtunes-storage.com/audio/${a}.${t.audioFile.name.split(".").pop()}`,duration:o.duration||180,language:u.language}});p.push(l)}let g=calculateReleaseDuration(p.map(e=>({id:e.id,title:e.title,trackNumber:e.trackNumber,duration:e.duration,filePath:e.audioUrl,isrc:e.isrc||void 0})));return n.Z.json({success:!0,message:"Release uploaded successfully",data:{releaseId:c.id,title:c.title,status:c.status,coverUrl:c.coverUrl,upc:c.upc,uploadedAt:c.createdAt,tracks:p.map(e=>({id:e.id,title:e.title,trackNumber:e.trackNumber,duration:formatDuration(e.duration),isrc:e.isrc})),summary:{trackCount:p.length,totalDuration:formatDuration(g),releaseType:u.type},fileInfo:{audioFiles:s.map(e=>({name:e.audioFile.name,size:e.audioFile.size,type:e.audioFile.type})),artwork:{name:l.name,size:t.length,type:"image/jpeg",dimensions:`${d.width}x${d.height}`}}}})}catch(e){throw await cleanupTempFiles(v),e}}catch(e){return console.error("Upload error:",e),n.Z.json({success:!1,message:"Upload failed. Please try again."},{status:500})}}async function GET(e){try{let t=e.headers.get("authorization"),a=(0,p.oA)(t);if(!a)return n.Z.json({success:!1,message:"Authentication required"},{status:401});let r=(0,p.WX)(a);if(!r)return n.Z.json({success:!1,message:"Invalid authentication token"},{status:401});let{searchParams:i}=new URL(e.url),s=i.get("releaseId");if(s){let e=await m.release.findFirst({where:{id:s,primaryArtistId:r.id},include:{tracks:{orderBy:{trackNumber:"asc"}},deliveries:!0}});if(!e)return n.Z.json({success:!1,message:"Release not found"},{status:404});let t=calculateReleaseDuration(e.tracks.map(e=>({id:e.id,title:e.title,trackNumber:e.trackNumber,duration:e.duration,filePath:e.audioUrl,isrc:e.isrc||void 0})));return n.Z.json({success:!0,data:{...e,summary:{trackCount:e.tracks.length,totalDuration:formatDuration(t)},tracks:e.tracks.map(e=>({...e,duration:formatDuration(e.duration)}))}})}{let e=await m.release.findMany({where:{primaryArtistId:r.id},include:{tracks:{orderBy:{trackNumber:"asc"}},deliveries:!0},orderBy:{createdAt:"desc"}}),t=e.map(e=>{let t=calculateReleaseDuration(e.tracks.map(e=>({id:e.id,title:e.title,trackNumber:e.trackNumber,duration:e.duration,filePath:e.audioUrl,isrc:e.isrc||void 0})));return{...e,summary:{trackCount:e.tracks.length,totalDuration:formatDuration(t)},tracks:e.tracks.map(e=>({...e,duration:formatDuration(e.duration)}))}});return n.Z.json({success:!0,data:t,count:e.length})}}catch(e){return console.error("Release fetch error:",e),n.Z.json({success:!1,message:"Internal server error"},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/upload/route",pathname:"/api/upload",filename:"route",bundlePath:"app/api/upload/route"},resolvedPagePath:"/Users/wizloxssd/Downloads/kushtunes-starter/app/api/upload/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:y,headerHooks:v,staticGenerationBailout:k}=g,w="/api/upload/route"}};var t=require("../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[4736,8592],()=>__webpack_exec__(1333));module.exports=a})();