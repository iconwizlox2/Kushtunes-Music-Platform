"use strict";(()=>{var e={};e.id=998,e.ids=[998],e.modules={7352:e=>{e.exports=require("@prisma/client/runtime/library.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},702:(e,a,t)=>{t.r(a),t.d(a,{headerHooks:()=>v,originalPathname:()=>j,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>y,staticGenerationAsyncStorage:()=>w,staticGenerationBailout:()=>h});var r={};t.r(r),t.d(r,{GET:()=>GET,POST:()=>POST});var s=t(884),i=t(6132),o=t(5798),u=t(6810),n=t(6113);let l=require("sharp");var d=t.n(l);let c=new u.PrismaClient,p=["audio/mpeg","audio/wav","audio/flac","audio/mp3"],g=["image/jpeg","image/jpg","image/png","image/webp"];function validateFile(e,a){let t="audio"===a?p:g;return e.size>("audio"===a?52428800:5242880)?{valid:!1,error:`File too large. Maximum size: ${"audio"===a?"50MB":"5MB"}`}:t.includes(e.type)?{valid:!0}:{valid:!1,error:`Invalid file type. Allowed: ${t.join(", ")}`}}async function optimizeImage(e){return await d()(e).resize(3e3,3e3,{fit:"inside",withoutEnlargement:!0}).jpeg({quality:90,progressive:!0}).toBuffer()}async function POST(e){try{let a=await e.formData(),t=a.get("audio"),r=a.get("artwork"),s=a.get("title"),i=a.get("artist"),u=a.get("genre"),l=a.get("language"),d=a.get("releaseDate"),p=a.get("releaseType")||"SINGLE";if(!t||!r||!s||!i)return o.Z.json({success:!1,message:"Missing required fields"},{status:400});let g=validateFile(t,"audio");if(!g.valid)return o.Z.json({success:!1,message:g.error},{status:400});let m=validateFile(r,"image");if(!m.valid)return o.Z.json({success:!1,message:m.error},{status:400});let f=(0,n.randomUUID)(),w=(0,n.randomUUID)(),y=(0,n.randomUUID)(),v=Buffer.from(await r.arrayBuffer()),h=await optimizeImage(v);Buffer.from(await t.arrayBuffer());let j=`https://kushtunes-storage.com/audio/${w}.${t.name.split(".").pop()}`,U=`https://kushtunes-storage.com/artwork/${y}.jpg`,k=`USRC${Date.now().toString().slice(-8)}`,x=`${Math.floor(9e11*Math.random())+1e11}`,D=await c.release.create({data:{id:f,userId:"demo-user-id",title:s,artist:i,type:p,status:"READY",plannedAt:d?new Date(d):new Date,coverUrl:U,audioUrl:j,genre:u,language:l,releaseDate:d?new Date(d):new Date,isrc:k,upc:x}});return await c.track.create({data:{id:w,releaseId:f,title:s,isrc:k,audioUrl:j,duration:Math.floor(300*Math.random())+120}}),o.Z.json({success:!0,message:"Release uploaded successfully",data:{releaseId:D.id,title:D.title,artist:D.artist,status:D.status,audioUrl:D.audioUrl,coverUrl:D.coverUrl,isrc:D.isrc,upc:D.upc,uploadedAt:D.createdAt,fileInfo:{audioSize:t.size,imageSize:h.length,audioType:t.type,imageType:"image/jpeg"}}})}catch(e){return console.error("Upload error:",e),o.Z.json({success:!1,message:"Upload failed. Please try again."},{status:500})}}async function GET(e){try{let{searchParams:a}=new URL(e.url),t=a.get("releaseId");if(t){let e=await c.release.findUnique({where:{id:t},include:{tracks:!0,distributions:{include:{analytics:{orderBy:{date:"desc"},take:30}}}}});if(!e)return o.Z.json({success:!1,message:"Release not found"},{status:404});return o.Z.json({success:!0,data:e})}{let e=await c.release.findMany({include:{tracks:!0,distributions:{include:{analytics:{orderBy:{date:"desc"},take:7}}}},orderBy:{createdAt:"desc"}});return o.Z.json({success:!0,data:e})}}catch(e){return console.error("Release fetch error:",e),o.Z.json({success:!1,message:"Internal server error"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/upload/route",pathname:"/api/upload",filename:"route",bundlePath:"app/api/upload/route"},resolvedPagePath:"/Users/wizloxssd/Downloads/kushtunes-starter/app/api/upload/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:w,serverHooks:y,headerHooks:v,staticGenerationBailout:h}=m,j="/api/upload/route"}};var a=require("../../../webpack-runtime.js");a.C(e);var __webpack_exec__=e=>a(a.s=e),t=a.X(0,[729,798,810],()=>__webpack_exec__(702));module.exports=t})();