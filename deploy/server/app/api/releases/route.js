"use strict";(()=>{var e={};e.id=6590,e.ids=[6590],e.modules={97352:e=>{e.exports=require("@prisma/client/runtime/library.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},57147:e=>{e.exports=require("fs")},71017:e=>{e.exports=require("path")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},20986:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>f,originalPathname:()=>h,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>g});var s={};r.r(s),r.d(s,{GET:()=>GET,PATCH:()=>PATCH,POST:()=>POST});var a=r(10884),i=r(16132),n=r(95798),u=r(96810),o=r(8192);let l=new u.PrismaClient;async function POST(e){try{let t=e.headers.get("authorization");if(!t)return n.Z.json({success:!1,message:"Authorization header required"},{status:401});let r=t.replace("Bearer ",""),s=(0,o.WX)(r);if(!s)return n.Z.json({success:!1,message:"Invalid token"},{status:401});let{title:a,version:i,label:u,releaseDate:c,territories:d,genre:p,subgenre:m,copyrightYear:f,pLine:g,cLine:h,tracks:w}=await e.json();if(!a||!c||!w||0===w.length)return n.Z.json({success:!1,message:"Title, release date, and tracks are required"},{status:400});let j=new Date(c),k=new Date;if(k.setDate(k.getDate()+7),j<k)return n.Z.json({success:!1,message:"Release date must be at least 7 days in the future"},{status:400});let v=await l.artist.findUnique({where:{email:s.email}});if(!v)return n.Z.json({success:!1,message:"Artist profile not found"},{status:404});let y=generateUPC(),Z=await l.$transaction(async e=>{let t=await e.release.create({data:{upc:y,title:a,version:i,label:u,primaryArtistId:v.id,releaseDate:j,territories:d||["US"],genre:p,subgenre:m,copyrightYear:f,pLine:g,cLine:h,status:"DRAFT"}}),r=[];for(let s=0;s<w.length;s++){let a=w[s],i=generateISRC(),n=await e.track.create({data:{releaseId:t.id,isrc:i,title:a.title,version:a.version,trackNumber:s+1,explicit:a.explicit||!1,language:a.language||"en",duration:a.duration,audioUrl:a.audioUrl,lyrics:a.lyrics}});if(a.contributors&&a.contributors.length>0)for(let t of a.contributors)await e.contributor.create({data:{trackId:n.id,name:t.name,role:t.role,ipi:t.ipi}});if(a.splits&&a.splits.length>0)for(let t of a.splits)await e.split.create({data:{trackId:n.id,artistId:v.id,percent:t.percent,recoupmentFlag:t.recoupmentFlag||!1}});r.push(n)}return{release:t,tracks:r}});return n.Z.json({success:!0,message:"Release created successfully",data:{release:{id:Z.release.id,upc:Z.release.upc,title:Z.release.title,status:Z.release.status,releaseDate:Z.release.releaseDate},tracks:Z.tracks.map(e=>({id:e.id,isrc:e.isrc,title:e.title,trackNumber:e.trackNumber}))}})}catch(e){return console.error("Create release error:",e),n.Z.json({success:!1,message:"Internal server error"},{status:500})}}async function PATCH(e,{params:t}){try{let r=e.headers.get("authorization");if(!r)return n.Z.json({success:!1,message:"Authorization header required"},{status:401});let s=r.replace("Bearer ",""),a=(0,o.WX)(s);if(!a)return n.Z.json({success:!1,message:"Invalid token"},{status:401});let{id:i}=t,u=await e.json(),c=await l.artist.findUnique({where:{email:a.email}});if(!c)return n.Z.json({success:!1,message:"Artist profile not found"},{status:404});let d=await l.release.findFirst({where:{id:i,primaryArtistId:c.id}});if(!d)return n.Z.json({success:!1,message:"Release not found"},{status:404});let p=await l.release.update({where:{id:i},data:{...u,updatedAt:new Date}});return n.Z.json({success:!0,message:"Release updated successfully",data:{release:{id:p.id,title:p.title,status:p.status,releaseDate:p.releaseDate}}})}catch(e){return console.error("Update release error:",e),n.Z.json({success:!1,message:"Internal server error"},{status:500})}}async function GET(e,{params:t}){try{let r=e.headers.get("authorization");if(!r)return n.Z.json({success:!1,message:"Authorization header required"},{status:401});let s=r.replace("Bearer ",""),a=(0,o.WX)(s);if(!a)return n.Z.json({success:!1,message:"Invalid token"},{status:401});let{id:i}=t,u=await l.artist.findUnique({where:{email:a.email}});if(!u)return n.Z.json({success:!1,message:"Artist profile not found"},{status:404});let c=await l.release.findFirst({where:{id:i,primaryArtistId:u.id},include:{tracks:{include:{contributors:!0,splits:!0}},deliveries:!0}});if(!c)return n.Z.json({success:!1,message:"Release not found"},{status:404});return n.Z.json({success:!0,data:{release:{id:c.id,title:c.title,status:c.status,releaseDate:c.releaseDate,tracks:c.tracks,deliveries:c.deliveries}}})}catch(e){return console.error("Get release status error:",e),n.Z.json({success:!1,message:"Internal server error"},{status:500})}}function generateUPC(){let e=Math.floor(1e5*Math.random()).toString().padStart(5,"0");return`123456${e}${Math.floor(10*Math.random())}`}function generateISRC(){let e=new Date().getFullYear().toString().slice(-2),t=Math.floor(1e5*Math.random()).toString().padStart(5,"0");return`US-KUSH-${e}-${t}`}let c=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/releases/route",pathname:"/api/releases",filename:"route",bundlePath:"app/api/releases/route"},resolvedPagePath:"/Users/wizloxssd/Downloads/kushtunes-starter/app/api/releases/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:m,headerHooks:f,staticGenerationBailout:g}=c,h="/api/releases/route"}};var t=require("../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[729,6449,5798,6810,8752,8192],()=>__webpack_exec__(20986));module.exports=r})();